<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Fiona Grimm">
<meta name="dcterms.date" content="2019-03-14">
<title>Using R to track NHS winter pressures â€“ NHS-R Community Quarto website</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//img/nhsr-logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-e33519c064eec2719b5a2f1f958bfacc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-617fa1a293f2d4bba6be0969c851d4df.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-e33519c064eec2719b5a2f1f958bfacc.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1T1K3D1BKL"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-1T1K3D1BKL', { 'anonymize_ip': true});
</script><link rel="stylesheet" href="../assets/nhsr.css">
</head>
<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://nhsrcommunity.com/" class="navbar-brand navbar-brand-logo">
    <img src="https://raw.githubusercontent.com/nhs-r-community/assets/main/logo/nhsr-logo.png" alt="NHS-R Community Logo which consists of the words and incorporating the R logo" class="navbar-logo"></a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../contact.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../events.html"> 
<span class="menu-text">Events</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../conference24.html"> 
<span class="menu-text">conference</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../books/index.html"> 
<span class="menu-text">Books</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog/index.html"> 
<span class="menu-text">Blogs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../packages.html"> 
<span class="menu-text">R Packages</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../getting-started.html"> 
<span class="menu-text">Getting Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../get-involved.html"> 
<span class="menu-text">Get Involved</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../fellowship.html"> 
<span class="menu-text">Fellowships</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/nhs-r-community" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns"><div id="title-block-header-title" class="quarto-title page-columns page-full page-layout-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);">
<h1 class="title">Using R to track NHS winter pressures</h1>
    <div class="quarto-categories">
        <div class="quarto-category">NHS</div>
        <div class="quarto-category">ggplot2</div>
        <div class="quarto-category">dplyr</div>
        <div class="quarto-category">base R</div>
        <div class="quarto-category">Data</div>
      </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fiona Grimm </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 14, 2019</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">June 12, 2024</p>
    </div>
  </div>
    
  </div>
  



</header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html --><!--
<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
--><!-- <header id="title-block-header" class="quarto-title-block default page-columns"> --><!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> --><p><strong>Every Thursday during winter, roughly from December to March, NHS Digital releases a weekâ€™s worth of hospital performance data,</strong> known as the <a href="https://www.england.nhs.uk/statistics/statistical-work-areas/winter-daily-sitreps/winter-daily-sitrep-2018-19-data/">Daily Situation Reports</a>. This data often receives media attention because cold weather and seasonal illnesses can lead to higher demand for hospital care, meaning that services might be under increased pressure. At the <a href="https://www.health.org.uk/">Health Foundation</a>, one of our aims is to provide new insight into the quality of health care through in-depth analysis of policy and data. So, to understand more about the current demand for hospital care and the challenges the NHS is facing, <a href="https://www.health.org.uk/news-and-comment/blogs/the-nhs-this-winter-looking-beneath-the-national-view">we keep a close eye on the latest seasonal trends</a>.</p>
<p><strong>Keeping on top of NHS winter indicators has the potential to keep us analysts busy.</strong> The raw data is published in a fairly complex spreadsheet, requires a decent amount of cleaning and needs to be reanalysed after every release. In addition to monitoring national figures, this winter our team at the Health Foundation also wanted to see if there might be any variation between different areas of England. Sustainability and transformation partnerships (STPs) are areas where health and care leaders develop shared proposals for local services. Therefore, we enriched the raw data with information about where hospitals are located, and which STP they belong to. But with a similar analytical approach, more fine-grained local structures (such as <a href="">Clinical Commissioning Groups</a>) could be used.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Original link to STPs page has moved. Original link shared <a href="https://www.england.nhs.uk/integratedcare/stps/view-stps/" class="uri">https://www.england.nhs.uk/integratedcare/stps/view-stps/</a></p>
</div></div><p>For a <strong>more efficient and reproducible way of tracking NHS winter indicators</strong> this year, we moved to our whole analysis pipeline to R. We then used the clean data for visualisations in R and other applications, like Tableau. This blog takes you through our analysis workflow and describes how we got through some tricky steps. The complete R script is also available on GitHub, if you want to give it a go yourself. You can also read a <a href="https://www.health.org.uk/news-and-comment/blogs/the-nhs-this-winter-looking-beneath-the-national-view">blog</a> on the Health Foundationâ€™s website to find out why we looked at local areas this year and what we found.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Original link to GitHub has been moved. Originally shared <a href="https://github.com/fiona-grimm/NHS_winter_pressures" class="uri">https://github.com/fiona-grimm/NHS_winter_pressures</a>. Could be <a href="https://github.com/HFAnalyticsLab/Winter_pressures" class="uri">https://github.com/HFAnalyticsLab/Winter_pressures</a></p>
</div></div><section id="why-write-this-blog-on-data-analysis" class="level1"><h1>Why write this blog on data analysis?</h1>
<p>Analysts at many other local and national organisations are interested in NHS winter performance data. In order for this blog to be a good resource for them, we plan to:</p>
<ul>
<li>share our own analytical approach and R code</li>
<li>illustrate how and why we made certain analytical decisions and</li>
<li>discuss what we learned along the way, both about the data and R.</li>
</ul>
<p>We hope that this blog will inspire others to do the same, and to share their code too. Here, we wonâ€™t try to interpret any regional differences in winter performance. We know that there are several factors involved, so we will leave this up to others with more local knowledge.</p>
</section><section id="r-packages-we-used" class="level1"><h1>1. R packages we used</h1>
<p>The <a href="https://www.tidyverse.org/">{tidyverse}</a> collection of R packages is a useful set of tools for data analysis and visualisation that are designed to work together. It contains the <a href="https://ggplot2.tidyverse.org/">{ggplot}</a> package, which we use for visualisations.</p>
<p>(Need help getting started with R and the {tidyverse}? Try the <a href="https://r4ds.hadley.nz/">R for Data Science</a> website).</p>
<p>We use a function from the {readxl} package to import Excel files and the {lubridate} package, which makes working with dates a lot easier. Both are part of the {tidyverse}.</p>
<p>Note: if you would like to run this code in your own R session and you havenâ€™t installed these packages already, you will need to do so (once) using the <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> function.</p>
</section><section id="data-download-from-nhs-digital" class="level1"><h1>2. Data download from NHS Digital</h1>
<p>After setting up the tools, we downloaded Winter Daily SitRep 2018â€“19 Data from the NHS Digital website. Rather than opting for the spreadsheets that contain one week of data each, we went for the more convenient time series file, which contains all data from this winter up to the latest release. One drawback is that the name of this file changes weekly as new data is added (so, should you try to use this code at a later date, you will probably have to adapt the file name).</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Download file</span></span>
<span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"Winter-data-timeseries-20190307.xlsx"</span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://www.england.nhs.uk/statistics/wp-content/uploads/sites/2/2019/03/Winter-data-timeseries-20190307.xlsx"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="va">url</span>, destfile <span class="op">=</span> <span class="va">filename</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Response [https://www.england.nhs.uk/statistics/wp-content/uploads/sites/2/2019/03/Winter-data-timeseries-20190307.xlsx]
  Date: 2025-06-23 12:47
  Status: 200
  Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
  Size: 1.51 MB
&lt;ON DISK&gt;  C:\Users\THOMAS~1.JEM\AppData\Local\Temp\Rtmpe2ltDH\file389ce42d6a.xlsx</code></pre>
</div>
</div>
</section><section id="data-import-from-r-unfriendly-spreadsheets" class="level1"><h1>3. Data import from R-unfriendly spreadsheets</h1>
<p>How we tackled multi-line headers with merged cells</p>
<p>Once we opened the file in Excel, we saw a number of sheets containing different indicators. With a few exceptions, most have a similar table structure. As we were interested in patient flow through hospitals, we focused on â€˜<strong>General and acute beds</strong>â€™ and <strong>â€™Beds occupied by long-stay patients</strong>â€™ for now.</p>
<p>What the sheets with these indicators had in common was that there was <strong>metadata</strong> in the first 13 lines followed by a two-line <strong>header</strong>. Several columns containing variables (second header line) were grouped within dates (first header line) and the cells around the dates were merged. There were also some empty columns and rows, which we addressed later on.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/excel_layout.png" class="img-fluid figure-img" alt="Screenshot of the Excel spreadsheet with metadata and blank lines"></p>
<figcaption>Example of the Excel layout of Winter SitRep data to be imported into R. Source: NHS Digital.</figcaption></figure>
</div>
<p>Unfortunately, this was not yet a <a href="https://r4ds.hadley.nz/data-tidy.html#sec-tidy-data">tidy table</a>, as the dates that served as column headers were values, not variable names. All this made importing the file into R slightly more challenging. We fixed this by creating a custom <code>import_sitrep()</code> function that would:</p>
<ul>
<li>read and store the data and the two lines of the header separately,</li>
<li>combine the two lines of the header,</li>
<li>add the combined header to the data and tidy up column names by removing special characters,</li>
<li>and finally convert the table into a tidy table ready for the next step.</li>
</ul>
<p>But wait, there was one more <strong>tricky bit</strong>. What happened when we tried to read in the headers one by one?</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">example_indicator</span> <span class="op">&lt;-</span> <span class="st">"G&amp;A beds"</span></span>
<span></span>
<span><span class="co"># First line contains dates in merged cells (5 cells merged each in this case)</span></span>
<span><span class="va">header_1</span> <span class="op">&lt;-</span> <span class="fu">read_xlsx</span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="va">filename</span>,</span>
<span>  sheet <span class="op">=</span> <span class="va">example_indicator</span>,</span>
<span>  skip <span class="op">=</span> <span class="fl">13</span>,</span>
<span>  col_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  n_max <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Second line contains variable names</span></span>
<span><span class="va">header_2</span> <span class="op">&lt;-</span> <span class="fu">read_xlsx</span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="va">filename</span>,</span>
<span>  sheet <span class="op">=</span> <span class="va">example_indicator</span>,</span>
<span>  skip <span class="op">=</span> <span class="fl">14</span>,</span>
<span>  col_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  n_max <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">header_1</span><span class="op">)</span></span>
<span><span class="co"># [1]   1 451</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">header_2</span><span class="op">)</span></span>
<span><span class="co"># [1]   1 459</span></span>
<span><span class="co"># why is header_1 eight columns shorter than header_2?</span></span>
<span></span>
<span><span class="co"># Start of header 1</span></span>
<span><span class="va">header_1</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="co"># #  A tibble: 1 x 10</span></span>
<span><span class="co">#    X__1                X__2  X__3  X__4  X__5  X__6                X__7  X__8  X__9  X__10</span></span>
<span><span class="co">#    &lt;dttm&gt;              &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;dttm&gt;              &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt;</span></span>
<span><span class="co"># 1 2018-12-03 00:00:00 NA    NA    NA    NA    2018-12-04 00:00:00 NA    NA    NA    NA</span></span>
<span></span>
<span><span class="co"># starts with the date column, we lost the few columns that contain trust code, name and so on. in line 2</span></span>
<span></span>
<span><span class="co"># End of header 1</span></span>
<span><span class="va">header_1</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">header_1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">10</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">header_1</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># # A tibble: 1 x 11</span></span>
<span><span class="co">#   X__441              X__442 X__443 X__444 X__445 X__446              X__447 X__448 X__449 X__450 X__451</span></span>
<span><span class="co">#   &lt;dttm&gt;              &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt;  &lt;dttm&gt;              &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt;  &lt;lgl&gt;  &lt;dttm&gt;</span></span>
<span><span class="co"># 1 2019-03-01 00:00:00 NA     NA     NA     NA     2019-03-02 00:00:00 NA     NA     NA     NA     2019-03-03 00:00:00</span></span>
<span></span>
<span><span class="co"># ends with only one column for 3 March - we lost the last four columns containing NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Sigh</em>â€¦ they ended up not having the same length. The first header line (containing the dates) was 8 elements shorter. Looking at its left and right side (see above) gave us a hint as to why this might have happened:</p>
<ul>
<li>In the Excel sheet, the first few cells in this line were empty and when the line was read in, they were converted to NA. The <code>read_xlsx()</code> function then discarded these empty columns (probably) because they were at the beginning.</li>
<li>There were also some merged cells. During import they were separated and, if empty, converted to NA. Empty columns at the end of the header line also seem to be discarded by <code>read_xlsx()</code>.</li>
</ul>
<p>So, we needed to find a way to preserve the length of the first header line in our <code>import_sitrep()</code> function. This is how we solved it:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">import_sitrep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span>, <span class="va">indicator</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">read_xlsx</span><span class="op">(</span>path <span class="op">=</span> <span class="va">file</span>, sheet <span class="op">=</span> <span class="va">indicator</span>, skip <span class="op">=</span> <span class="fl">15</span>, col_names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract first header line containing dates and fill the gaps:</span></span>
<span>  <span class="co"># Read 2 lines but guess the data types only from the first row</span></span>
<span>  <span class="co"># Based on the first line, the function expects dates and</span></span>
<span>  <span class="co"># convert the second row to NA</span></span>
<span>  <span class="co"># As a result, the right length is preserved.</span></span>
<span>  <span class="va">header_1</span> <span class="op">&lt;-</span> <span class="fu">read_xlsx</span><span class="op">(</span>path <span class="op">=</span> <span class="va">file</span>, sheet <span class="op">=</span> <span class="va">indicator</span>, skip <span class="op">=</span> <span class="fl">13</span>, col_names <span class="op">=</span> <span class="cn">FALSE</span>, n_max <span class="op">=</span> <span class="fl">2</span>, guess_max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Convert to columns, fill in the gaps and convert into vector</span></span>
<span>  <span class="va">header_1</span> <span class="op">&lt;-</span> <span class="va">header_1</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">fill</span><span class="op">(</span><span class="va">.</span>, <span class="st">"V1"</span><span class="op">)</span></span>
<span>  <span class="va">header_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">header_1</span><span class="op">$</span><span class="va">V1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract second header and convert into vector</span></span>
<span>  <span class="va">header_2</span> <span class="op">&lt;-</span> <span class="fu">read_xlsx</span><span class="op">(</span>path <span class="op">=</span> <span class="va">file</span>, sheet <span class="op">=</span> <span class="va">indicator</span>, skip <span class="op">=</span> <span class="fl">14</span>, col_names <span class="op">=</span> <span class="cn">FALSE</span>, n_max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">header_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">header_2</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Concatenating headers to create column names</span></span>
<span>  <span class="co"># Replace NAs with a placeholder, otherwise concatenation fails</span></span>
<span>  <span class="va">column_names</span> <span class="op">&lt;-</span> <span class="fu">str_c</span><span class="op">(</span><span class="fu">str_replace_na</span><span class="op">(</span><span class="va">header_1</span>, <span class="st">"placeholder"</span><span class="op">)</span>, <span class="fu">str_replace_na</span><span class="op">(</span><span class="va">header_2</span>, <span class="st">"placeholder"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add column names to data and tidy</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">column_names</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"."</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"placeholder_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"'"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"&lt;"</span>, <span class="st">"less.than"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"&gt;"</span>, <span class="st">"more.than"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Tidy up table</span></span>
<span>  <span class="va">data_tidy</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># remove empty column and line</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">placeholder</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># Separate variables and dates</span></span>
<span>    <span class="fu">gather</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">3</span>, key <span class="op">=</span> <span class="st">"date_type"</span>, value <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">separate</span><span class="op">(</span><span class="va">date_type</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"type"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">spread</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"type"</span>, value <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="co"># convert to the right variable types</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate_at</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>, <span class="fu">funs</span><span class="op">(</span><span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">data_tidy</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we had our import function, we were ready to read and combine the sheets containing the winter indicators â€˜<strong>General and acute beds</strong>â€™ and â€˜<strong>Beds occupied by long-stay patients</strong>â€™.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sheets_to_import</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"G&amp;A beds"</span>, <span class="st">"Beds Occ by long stay patients"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">sheets_to_import</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">map</span><span class="op">(</span><span class="va">import_sitrep</span>,</span>
<span>    file <span class="op">=</span> <span class="va">filename</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">reduce</span><span class="op">(</span><span class="va">left_join</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nhs.england.region"</span>, <span class="st">"code"</span>, <span class="st">"name"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># What does our data look like now?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">Sitrep_daily</span><span class="op">)</span></span>
<span><span class="co"># [1] 12285    12</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Sitrep_daily</span><span class="op">)</span></span>
<span><span class="co"># # A tibble: 6 x 12</span></span>
<span><span class="co">#   nhs.england.reg~ code  name  date       core.beds.open escalation.beds~ occupancy.rate total.beds.occd total.beds.open</span></span>
<span><span class="co">#   &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt; &lt;date&gt;              &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span><span class="co"># 1 -                -     ENGL~ 2018-12-03          93702             2701          0.949           91533           96403</span></span>
<span><span class="co"># 2 -                -     ENGL~ 2018-12-04          93720             2556          0.949           91322           96276</span></span>
<span><span class="co"># 3 -                -     ENGL~ 2018-12-05          93739             2434          0.948           91143           96173</span></span>
<span><span class="co"># 4 -                -     ENGL~ 2018-12-06          93617             2389          0.946           90862           96006</span></span>
<span><span class="co"># 5 -                -     ENGL~ 2018-12-07          93822             2084          0.931           89333           95906</span></span>
<span><span class="co"># 6 -                -     ENGL~ 2018-12-08          93635             2191          0.929           89021           95826</span></span>
<span><span class="co"># # ... with 3 more variables: more.than.14.days &lt;dbl&gt;, more.than.21.days &lt;dbl&gt;, more.than.7.days &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data was now tidy, as each variable formed a column and each observation formed a row. Note that the observations for England in the table were followed by values for individual hospital trusts.</p>
</section><section id="data-cleaning" class="level1"><h1>4. Data cleaning</h1>
<section id="trust-exclusions" class="level2"><h2 class="anchored" data-anchor-id="trust-exclusions">Trust exclusions</h2>
<p>We excluded the three <strong>childrenâ€™s hospitals</strong> when calculating aggregate measures, such as the average bed occupancy within STPs. Our reasoning was that their patient profiles would be different from other acute trusts and this might skew the averages. Nevertheless, we kept track of them at a trust level.</p>
<p>This applies to Birmingham Womenâ€™s and Childrenâ€™s NHS Foundation Trust (code <strong>RQ3</strong>), Alder Hey Childrenâ€™s NHS Foundation Trust (<strong>RBS</strong>) and Sheffield Childrenâ€™s NHS Foundation Trust (<strong>RCU</strong>).</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trusts_to_exclude_for_aggregation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RQ3"</span>, <span class="st">"RBS"</span>, <span class="st">"RCU"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="how-we-approached-defining-missingness-when-is-a-zero-not-a-zero" class="level2"><h2 class="anchored" data-anchor-id="how-we-approached-defining-missingness-when-is-a-zero-not-a-zero">How we approached defining â€˜missingnessâ€™: when is a zero not a zero?</h2>
<p>Data collection and validation errors do happen, so finding suspicious data points is an important step during data cleaning.</p>
<p>While this is easy if a value is missing (or NA), itâ€™s much harder to decide whether a zero truly represents â€˜zero eventsâ€™ or a missing value (in fact, it could even be both within the same data set). To distinguish between the two, at the Health Foundation we came up with the following criteria:</p>
<ul>
<li>How likely is a â€˜zero eventâ€™ for an indicator? For example, when counting beds in a large hospital the likelihood of having zero open seems small, but when counting long-stay patients having none seems possible.</li>
<li>How consistent is the zero value, in that trust, over time? Or in plain English: does the value jump from a higher number to zero (and back) or is it hovering somewhere close to zero.</li>
</ul>
<p>The next two sections describe how we found and dealt with these missing values.</p>
</section><section id="finding-longer-periods-of-missing-data" class="level2"><h2 class="anchored" data-anchor-id="finding-longer-periods-of-missing-data">Finding longer periods of missing data</h2>
<p>If any hospital trust had missing values, in any indicator, on <strong>4 or more consecutive days</strong> during the reporting period, it was excluded from the analysis. We were only looking for these periods in variables where we would not expect any zeros (the list is shown as cols_to_check).</p>
<p>Why this particular cut-off? We wanted to aggregate the data and calculating weekly averages did not seem justified if we were missing more than half of a week for any trust.</p>
<p>Hereâ€™s how we summed up how many consecutive days were zero or NA within each trust/variable combination:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Only check variables that are not derived from other variables</span></span>
<span><span class="va">cols_to_check</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"core.beds.open"</span>, <span class="st">"total.beds.occd"</span>,</span>
<span>  <span class="st">"more.than.7.days"</span>, <span class="st">"more.than.14.days"</span>, <span class="st">"more.than.21.days"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find values that are 0 or NA</span></span>
<span><span class="co"># within any trust/variable combination</span></span>
<span><span class="va">Sitrep_missing_or_zero</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">!=</span> <span class="st">"ENGLAND"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Updated code from `gather(cols_to_check, key = "variable", value = "value") %&gt;%`</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="va">cols_to_check</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"variable"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Sort and assign a period ID to consecutive days</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">code</span>, <span class="va">variable</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">code</span>, <span class="va">variable</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    periodID <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">diff</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarise consecutive days that variables are missing</span></span>
<span><span class="va">Days_missing</span> <span class="op">&lt;-</span> <span class="va">Sitrep_missing_or_zero</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># remove trusts we already decided to exclude</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude_for_aggregation</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">code</span>, <span class="va">variable</span>, <span class="va">periodID</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>days <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="fu">last</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">-</span> <span class="fu">first</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">days</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">Days_missing</span><span class="op">[</span><span class="va">Days_missing</span><span class="op">$</span><span class="va">days</span> <span class="op">&gt;=</span> <span class="fl">4</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 11 x 4</span></span>
<span><span class="co"># # Groups:   code, variable [11]</span></span>
<span><span class="co">#    code  variable          periodID  days</span></span>
<span><span class="co">#    &lt;chr&gt; &lt;chr&gt;                &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#  1 RTD   more.than.14.days        1    85</span></span>
<span><span class="co">#  2 RTD   more.than.21.days        1    85</span></span>
<span><span class="co">#  3 RTD   more.than.7.days         1    85</span></span>
<span><span class="co">#  4 RQW   more.than.14.days        1     8</span></span>
<span><span class="co">#  5 RQW   more.than.21.days        1     8</span></span>
<span><span class="co">#  6 RQW   more.than.7.days         1     8</span></span>
<span><span class="co">#  7 RQW   total.beds.occd          1     8</span></span>
<span><span class="co">#  8 RQW   core.beds.open           1     7</span></span>
<span><span class="co">#  9 RAX   more.than.14.days        1     6</span></span>
<span><span class="co"># 10 RAX   more.than.21.days        1     6</span></span>
<span><span class="co"># 11 RAX   more.than.7.days         1     6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we filtered for 4 or more consecutive days, we found that:</p>
<ul>
<li>The trust with the code <strong>RTD</strong> reported zero long-stay patients (of any length of stay) for the whole reporting period to date, which seemed unrealistic for a general and acute hospital.</li>
<li>Trust <strong>RQW</strong> had a gap of 7â€“8 days, that coincided for the indicators shown (we checked this separately in the raw data).</li>
<li>Trust <strong>RAX</strong> reported zero long-stay patients (of any length of stay) for 6 days during January, but reported a high number before and after.</li>
</ul>
<p>Based on this, all variables from the trusts RTD, RQW and RAX were excluded from the analysis of this yearâ€™s (2018/19) winter data. This left us with 128 out of 134 trusts.</p>
<p>Itâ€™s worth noting that with this data-driven approach different trusts might be excluded each year and the number of excluded trusts could change over the winter period as new â€˜gapsâ€™ appear. Keep this in mind when making comparisons, both throughout the winter period and between years.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trusts_to_exclude</span> <span class="op">&lt;-</span> <span class="va">Days_missing</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">days</span> <span class="op">&gt;=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Extract column as vector</span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">trusts_to_exclude</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "RTD" "RQW" "RAX"</code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1] "RTD" "RQW" "RAX"</span></span>
<span></span>
<span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">Sitrep_daily</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12012    12</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># [1] 12012    12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="dealing-with-shorter-data-gaps" class="level2"><h2 class="anchored" data-anchor-id="dealing-with-shorter-data-gaps">Dealing with shorter data gaps</h2>
<p>Next, we checked how many missing or zero values were left:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># How many 1,2 and 3-day gaps are there?</span></span>
<span><span class="va">Days_missing</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">days</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 3 x 2</span></span>
<span><span class="co"># # Groups:   days [3]</span></span>
<span><span class="co">#    days     n</span></span>
<span><span class="co">#   &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co"># 1     1    42</span></span>
<span><span class="co"># 2     2     3</span></span>
<span><span class="co"># 3     3     9</span></span>
<span></span>
<span><span class="co"># How are they distributed between trusts and variables?</span></span>
<span><span class="va">Days_missing</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">code</span>, <span class="va">variable</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">spread</span><span class="op">(</span>key <span class="op">=</span> <span class="st">"variable"</span>, value <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># # A tibble: 11 x 6</span></span>
<span><span class="co"># # Groups:   code [11]</span></span>
<span><span class="co">#    code  core.beds.open more.than.14.days more.than.21.days more.than.7.days total.beds.occd</span></span>
<span><span class="co">#    &lt;chr&gt;          &lt;int&gt;             &lt;int&gt;             &lt;int&gt;            &lt;int&gt;           &lt;int&gt;</span></span>
<span><span class="co">#  1 RA2               NA                 1                NA               NA              NA</span></span>
<span><span class="co">#  2 RA3               NA                 1                 1                1              NA</span></span>
<span><span class="co">#  3 RA4                1                 1                 1                1               1</span></span>
<span><span class="co">#  4 RAL               NA                 1                 1                1              NA</span></span>
<span><span class="co">#  5 RBT               NA                 1                 1                1              NA</span></span>
<span><span class="co">#  6 RFR                3                 3                 3                3               3</span></span>
<span><span class="co">#  7 RHM               NA                 2                 2                2              NA</span></span>
<span><span class="co">#  8 RJ7               NA                 1                 1                1              NA</span></span>
<span><span class="co">#  9 RM3               NA                 1                 1                1              NA</span></span>
<span><span class="co"># 10 RQM               NA                 1                 1                1              NA</span></span>
<span><span class="co"># 11 RQX               NA                 3                 3                3              NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Most of the remaining gaps (42 out of 54) consisted of only a single day and they were mostly found in variables relating to long-stay patients. To judge whether these looked like real â€˜zero eventsâ€™ or were more likely to be reporting errors, we had a closer look at the data:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract and plot trusts with zeros in their data.</span></span>
<span><span class="va">Sitrep_daily_small_gaps</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">code</span>, <span class="va">date</span>, <span class="va">cols_to_check</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">Days_missing</span><span class="op">$</span><span class="va">code</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">gather</span><span class="op">(</span><span class="va">cols_to_check</span>, key <span class="op">=</span> <span class="st">"variable"</span>, value <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Sitrep_daily_small_gaps</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">code</span>, color <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="st">"variable"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="using-r-to-track-nhs-winter-pressures_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Before cleaning: plots showing the subset of trusts reporting â€˜0â€™ in any (non-derived) variable.</figcaption></figure>
</div>
</div>
</div>
<p>Based on the data before and after the zeroes, these were unlikely to be true values. It would have been possible to impute these gaps in some way, for example by taking the mean of day before and the day after. Instead, we took the approach that required fewest assumptions and we just replaced the gaps with NA:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">##### Original code (base R) gives error "Error in `na_if()`:! Can't convert `y` &lt;double&gt; to match type of `x` &lt;tbl_df&gt;."</span></span>
<span></span>
<span><span class="co"># Create a 'clean' version where 0s were replaced with NA</span></span>
<span><span class="co"># Sitrep_daily[cols_to_check] &lt;- na_if(Sitrep_daily[cols_to_check], 0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Coded to na using {tidyverse} functions and then plotted</span></span>
<span><span class="va">Sitrep_daily_na</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">na_if</span><span class="op">(</span><span class="va">.</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Sitrep_daily_na</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily_na</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">code</span>, <span class="va">date</span>, <span class="va">cols_to_check</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">code</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">Days_missing</span><span class="op">$</span><span class="va">code</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">gather</span><span class="op">(</span><span class="va">cols_to_check</span>, key <span class="op">=</span> <span class="st">"variable"</span>, value <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">Sitrep_daily_na</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">code</span>, color <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="st">"variable"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="using-r-to-track-nhs-winter-pressures_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" alt="After cleaning: plots showing the same trusts after replacing zeros with NA." width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="validating-derived-variables" class="level2"><h2 class="anchored" data-anchor-id="validating-derived-variables">Validating derived variables</h2>
<p>Some variables present in the data set were derived from others: for example,<code>total.beds.occd</code> should be the sum of <code>core.beds.open</code> and <code>escalation.beds.open</code>.</p>
<p>We could have discarded derived variables straight away and then computed them ourselves, in order to be completely sure about how they have been derived and what they mean. Since we were curious about their quality, we first checked if <code>total.beds.open</code> and <code>occupancy.rate</code> had been calculated as expected so we could decide whether or not to replace them (spoiler: yes, we did).</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    total.beds.open.check <span class="op">=</span> <span class="va">core.beds.open</span> <span class="op">+</span> <span class="va">escalation.beds.open</span>,</span>
<span>    occupancy.rate.check <span class="op">=</span> <span class="va">total.beds.occd</span> <span class="op">/</span> <span class="op">(</span><span class="va">core.beds.open</span> <span class="op">+</span> <span class="va">escalation.beds.open</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Are the newly derives values the same as the existing ones?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">Sitrep_daily</span><span class="op">$</span><span class="va">occupancy.rate</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">Sitrep_daily</span><span class="op">$</span><span class="va">occupancy.rate.check</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">Sitrep_daily</span><span class="op">$</span><span class="va">total.beds.open</span> <span class="op">==</span> <span class="va">Sitrep_daily</span><span class="op">$</span><span class="va">total.beds.open.check</span><span class="op">)</span></span>
<span><span class="co"># FALSE</span></span>
<span></span>
<span><span class="co"># Where are the mismatches?</span></span>
<span><span class="va">Sitrep_daily</span><span class="op">[</span></span>
<span>  <span class="va">Sitrep_daily</span><span class="op">$</span><span class="va">total.beds.open</span> <span class="op">!=</span> <span class="va">Sitrep_daily</span><span class="op">$</span><span class="va">total.beds.open.check</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"code"</span>, <span class="st">"date"</span>, <span class="st">"core.beds.open"</span>, <span class="st">"escalation.beds.open"</span>, <span class="st">"total.beds.open"</span>,</span>
<span>    <span class="st">"total.beds.open.check"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co">#  A tibble: 5 x 6</span></span>
<span><span class="co">#   code  date       core.beds.open escalation.beds.open total.beds.open total.beds.open.check</span></span>
<span><span class="co">#   &lt;chr&gt; &lt;date&gt;              &lt;dbl&gt;                &lt;dbl&gt;           &lt;dbl&gt;                 &lt;dbl&gt;</span></span>
<span><span class="co"># 1 -     2018-12-16          93489                 2125           95604                 95614</span></span>
<span><span class="co"># 2 -     2018-12-30          93014                 2475           95104                 95489</span></span>
<span><span class="co"># 3 -     2019-02-08          93931                 3718           97080                 97649</span></span>
<span><span class="co"># 4 R1H   2019-02-08           1270                   80             781                  1350</span></span>
<span><span class="co"># 5 RXK   2018-12-16            587                   22             599                   609</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Looks like we will have to re-derive both variables after all</span></span>
<span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    total.beds.open <span class="op">=</span> <span class="va">core.beds.open</span> <span class="op">+</span> <span class="va">escalation.beds.open</span>,</span>
<span>    occupancy.rate <span class="op">=</span> <span class="va">total.beds.occd</span> <span class="op">/</span> <span class="op">(</span><span class="va">core.beds.open</span> <span class="op">+</span> <span class="va">escalation.beds.open</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, if it had been the focus of our analysis, we would also have re-derived national aggregates for England.</p>
</section></section><section id="feature-engineering" class="level1 page-columns page-full"><h1>5. Feature engineering</h1>
<p><strong>Adding organisational information on sustainability and transformation partnerships (STPs)</strong></p>
<p>As we wanted to compare indicators between local areas, we decided to calculate averages of winter indicators over hospital trusts within each STP. To do this, we needed to add variables to the raw data that indicated which hospital trust belonged to which STP. Unfortunately, we were not aware that this information was available in a format convenient for data analysis.</p>
<p>So, we manually created and validated a lookup table to map hospital trusts to STPs, using information related to the 2017/18 formation of 44 STPs from NHS England. While some STPs have since changed (for example, three STPs in the north of England merged in August 2018), this was the latest and most comprehensive information available, as far as we are aware.</p>

<div class="no-row-height column-margin column-container"><div class="margin-aside">
<p>Pages no longer found: <a href="https://www.england.nhs.uk/integratedcare/stps/view-stps/" class="uri">https://www.england.nhs.uk/integratedcare/stps/view-stps/</a> <a href="https://digital.nhs.uk/services/organisation-data-service/organisation-data-service-news-and-latest-updates/august-2018-newsletter" class="uri">https://digital.nhs.uk/services/organisation-data-service/organisation-data-service-news-and-latest-updates/august-2018-newsletter</a></p>
</div></div><p>The allocation of most hospital trusts to STPs was straightforward using this list, but there were a few instances where we had to choose:</p>
<ul>
<li>If a trust did not appear in any STP list, it was matched according to the location of its main acute site. This was the case for four trusts in Northumberland, Tyne and Wear and North Durham STP.</li>
<li>If a trust was mentioned in more than one STP plan, it was allocated according to the location of its main acute site. This applied to both Chesterfield Royal Hospital NHS Foundation Trust and Epsom And St Helier University Hospitals NHS Trust.</li>
</ul>
<p>We think this is a reasonable approach when analysing winter indicators, which mainly come from acute trusts, but we would be keen to hear your feedback.</p>
<p>Once we had this lookup table, we imported it into R and merged it with the winter indicators:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">STP_lookup</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/HFAnalyticsLab/Winter_pressures/85313135c7dee393f52fa47596f04eb390bc43a3/Trust-STP-lookup.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># join by code only to avoid any problems due to inconsistencies in spelling</span></span>
<span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">STP_lookup</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"code"</span>, <span class="st">"STP"</span>, <span class="st">"STP_code"</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"code"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The lookup table is also available on Github. Please note that STPs change and develop over time, so if you would like to use it, itâ€™s worth checking that the information is up to date.</p>
<section id="making-read-outs-comparable-between-trusts-from-raw-counts-to-rates" class="level2"><h2 class="anchored" data-anchor-id="making-read-outs-comparable-between-trusts-from-raw-counts-to-rates">Making read-outs comparable between trusts: from raw counts to rates</h2>
<p>As hospital trusts come in different sizes and serve different numbers of patients, raw patient counts are not suitable for comparisons between trusts or regions. Percentages or fractions, such bed occupancy rates, are more comparable.</p>
<p>Therefore, we derived the fraction of occupied beds, which are occupied by long-stay patients over 7, 14 or 21 days:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rate of occupied beds that are occupied by long-stay patients</span></span>
<span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    more.than.7.rate <span class="op">=</span> <span class="va">more.than.7.days</span> <span class="op">/</span> <span class="va">total.beds.occd</span>,</span>
<span>    more.than.14.rate <span class="op">=</span> <span class="va">more.than.14.days</span> <span class="op">/</span> <span class="va">total.beds.occd</span>,</span>
<span>    more.than.21.rate <span class="op">=</span> <span class="va">more.than.21.days</span> <span class="op">/</span> <span class="va">total.beds.occd</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="aggregation-monthly-averages-by-stp" class="level1"><h1>6. Aggregation: monthly averages by STP</h1>
<p>In some cases, it might be useful to visualise daily changes, but weekly or even monthly aggregates have the advantage of being less noisy, free of weekday-weekend variation and can potentially be more useful to monitor longer-term trends.</p>
<p>First, we created a new column that contained the corresponding month. The month was then used as grouping variable, along with the trust or STP code, to calculate monthly averages of bed occupancy and long-stay patient rates.</p>
<p>For weekly averages, an alternative would have been to create a new column containing the date of the respective beginning of the week using the <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> function (also shown below).</p>
<p>We know itâ€™s also good practice to keep track of the number of valid observations (as in, not NA) that we average over within each group used. In this instance, for trust-level aggregates, this represented the number of days within a week. For STP-level aggregates, it corresponded to the number of trusts within the STP.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Sitrep_daily</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    week_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">date</span>, breaks <span class="op">=</span> <span class="st">"week"</span>, start.on.monday <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, <span class="co"># can be used to aggregate by week</span></span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">date</span>, format <span class="op">=</span> <span class="st">"%B"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Monthly average on trust level</span></span>
<span><span class="va">Sitrep_monthly_average_bytrust</span> <span class="op">&lt;-</span> <span class="va">Sitrep_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">nhs.england.region</span>, <span class="va">code</span>, <span class="va">name</span>, <span class="va">STP</span>, <span class="va">STP_code</span>, <span class="va">month</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Count the number of valid observations for each variable</span></span>
<span>  <span class="co"># BEFORE we overwrite the variables</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    occupancy.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">occupancy.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    more.than.7.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">more.than.7.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    more.than.14.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">more.than.14.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    more.than.21.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">more.than.21.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    occupancy.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">occupancy.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    more.than.7.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">more.than.7.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    more.than.14.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">more.than.14.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    more.than.21.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">more.than.21.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Monthly average on STP level</span></span>
<span><span class="va">Sitrep_monthly_average_bySTP</span> <span class="op">&lt;-</span> <span class="va">Sitrep_monthly_average_bytrust</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">is.element</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">trusts_to_exclude_for_aggregation</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">STP</span>, <span class="va">STP_code</span>, <span class="va">month</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    occupancy.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">occupancy.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    more.than.7.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">more.than.7.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    more.than.14.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">more.than.14.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    more.than.21.rate.valid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">more.than.21.rate</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    occupancy.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">occupancy.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    more.than.7.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">more.than.7.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    more.than.14.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">more.than.14.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    more.than.21.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">more.than.21.rate</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, we also saved the tidy and aggregated data as a CSV file for visualisation in other programs, such as Tableau.</p>
</section><section id="visualisation-how-we-mapped-stp-level-data-in-r" class="level1"><h1>7. Visualisation: how we mapped STP-level data in R</h1>
<p>There are endless ways to creatively visualise aspects of this data (the <a href="https://www.r-graph-gallery.com/">R Graph Gallery</a> is a great place to get inspired). We wanted to plot a map of STP boundaries and colour-shade them according to the average bed occupancy in each winter month.</p>
<p><a href="https://www.data.gov.uk/dataset/f4b28835-0036-44f0-aa0d-0c402a6609e5/sustainability-and-transformation-partnerships-february-2017-ultra-generalised-clipped-boundaries-in-england">STP boundaries</a> are available as a GeoJSON file from the Office for National Statistics (ONS). We downloaded and imported the digital vector file and then created a plot to get a first idea of what was in the file:</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
GeoJSON data no longer available from data.gov
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Original code provided the link cannot run as GeoJSON files no longer available from the data.gov site - only csv.</p>
<p>From the <a href="https://geoportal.statistics.gov.uk/datasets/ons::stp-feb-2017-super-generalised-clipped-boundaries-in-england/explore?location=52.723908%2C-2.489798%2C6.76">Open Geography portal</a> url link can be generated from <code>I want to use this</code> link in bottom left then View API Resources which gives GeoJSON link.</p>
<p>To map the code was edited to {ggplot2} following <a href="https://r-graph-gallery.com/325-background-map-from-geojson-format-in-r.html">R gallery</a> examples</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">######### Original code not run - see call out box #############</span></span>
<span></span>
<span><span class="co"># Download and read file containing STP shapes from the ONS website</span></span>
<span><span class="co"># We use the smaller, generalised version for mapping rather than the full boundaries</span></span>
<span></span>
<span><span class="co"># STP_geojson_filename &lt;- "Sustainability_and_Transformation_Partnerships_February_2017_Ultra_Generalised_Clipped_Boundaries_in_England.geojson.json"</span></span>
<span><span class="co"># STP_geojson_url &lt;- "http://geoportal1-ons.opendata.arcgis.com/datasets/571bd4512165461fad70a0ccc36450e4_4.geojson"</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># download.file(STP_geojson_url, STP_geojson_filename)</span></span>
<span><span class="co"># data_json &lt;- geojson_read(STP_geojson_filename, what = "sp")</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># plot(data_json)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmp_geojson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".geojson"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/STP_Feb_2017_SGCB_in_England_2022/FeatureServer/0/query?outFields=*&amp;where=1%3D1&amp;f=geojson"</span>,</span>
<span>  <span class="va">tmp_geojson</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_sf</span> <span class="op">&lt;-</span> <span class="fu">read_sf</span><span class="op">(</span><span class="va">tmp_geojson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">my_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="using-r-to-track-nhs-winter-pressures_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" alt="Boundaries of Sustainability and Transformation Partnerships in England (2017). Data source: ONS." width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> function provided a convenient way to divide the variable bed.occupancy into meaningful intervals and to add labels that could be displayed on the map. Converting variables into factors and ordering the factor levels using <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> ensured that the intervals and months were in the right order. We were then ready to plot and save the map:</p>
<div class="cell preview-image">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">STP_shape_monthly</span> <span class="op">&lt;-</span> <span class="va">my_sf</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">Sitrep_monthly_average_bySTP</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"stp17cd"</span> <span class="op">=</span> <span class="st">"STP_code"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">STP_shape_monthly</span> <span class="op">&lt;-</span> <span class="va">STP_shape_monthly</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Divide variable into intervals and turn into factors</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    occupancy.rate.cut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">occupancy.rate</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.85</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"85% or less"</span>, <span class="st">"85-90%"</span>, <span class="st">"90-95%"</span>, <span class="st">"over 95%"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    occupancy.rate.cut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">occupancy.rate.cut</span><span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">occupancy.rate.cut</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Remove lines relating England as a whole</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">STP</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Turn STPs and months into factors (ignoring March)</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">stp17cd</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">stp17cd</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">month</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"December"</span>, <span class="st">"January"</span>, <span class="st">"February"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot and save the map</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">STP_shape_monthly</span>, <span class="fu">aes</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">long</span>,</span>
<span>  y <span class="op">=</span> <span class="va">lat</span>,</span>
<span>  fill <span class="op">=</span> <span class="va">occupancy.rate.cut</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Remove grid lines</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Ensure correct aspect ratio</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Facet by month</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">month</span>, switch <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Define colour palette</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#dd0031"</span>, <span class="st">"#ee7074"</span>, <span class="st">"#f2a0a2"</span>, <span class="st">"#aad3e5"</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">FALSE</span>, label.hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Average bed occupancy within STPs during winter 2018/19"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Other design choices</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span>, colour <span class="op">=</span> <span class="st">"#005078"</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>b <span class="op">=</span> <span class="fl">15</span>, unit <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    legend.key <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>t <span class="op">=</span> <span class="fl">5</span>, b <span class="op">=</span> <span class="fl">5</span>, l <span class="op">=</span> <span class="fl">10</span>, r <span class="op">=</span> <span class="fl">10</span>, unit <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#524c48"</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.spacing.x <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">10</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    legend.spacing.y <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">10</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#524c48"</span>, margin <span class="op">=</span> <span class="fu">margin</span><span class="op">(</span>b <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="using-r-to-track-nhs-winter-pressures_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>How could we have improved this map further? One option might have been to interactively display STP averages when hovering over the map using the <a href="https://r-graph-gallery.com/interactive-charts">{plotly}</a> package, for example.</p>
</section><section id="what-have-we-learned" class="level1"><h1>8. What have we learned?</h1>
<p>Lots! No, seriouslyâ€¦ Using this workflow, rather than copy and paste, has saved us a lot of time this winter. But beyond that, creating (then revisiting and improving) this workflow turned out to be a great way to work together and to make our analysis more transparent, more reproducible and easier to understand.</p>
<p>Key points we are taking away:</p>
<ul>
<li>With trusts, CCGs, STPs, ICSs, and more to choose from when weâ€™re looking at local variation within health care systems, <strong>it can be challenging to pick the right organisational level</strong>. Local health care structures are also changing and evolving rapidly. We need to do more thinking about which level is most informative and compare different option, suggestions are welcome.</li>
<li>
<strong>Some cleaning is a must</strong>. Winter data has a quick turnaround and NHS Digital only perform minimal validation. However, compared to previous years, the 2018/19 winter data quality has markedly improved (you can use our code to check the improvement for yourself).</li>
<li>But <strong>cleaning decisions impact interpretability</strong>. If the list of excluded trusts changes between years (based on how well they are reporting in any given year), this makes the data less comparable year-on-year.</li>
<li>
<strong>Weâ€™ll play it safe with derived variables</strong>. The effort of rederiving them ourselves was worth it for the peace of mind we got from knowing that they were calculated consistently and meant exactly what we thought they meant.</li>
<li>Next winter, <strong>our future selves will be very happy</strong> to have our analysis nicely documented with code that is ready to go. It should even be easy to adapt the same workflow for other open NHS data sets (weâ€™ll save this for another time).</li>
</ul>
<p><strong>Editor note:</strong> - Updating this blog from 2019 in 2024 required a number of changes to functions and packages but the code was easier to change and debug than to build from scratch, particularly for someone who isnâ€™t familiar with any mapping or geospatial coding!</p>
<p>{tidyverse} was used in recoding where the original was sometimes in base R.</p>
<p>This blog has been formatted to remove <a href="https://nhsrway.nhsrcommunity.com/style-guides.html#avoid-latin-abbreviation">Latin Abbreviations</a> and edited for <a href="https://nhsrway.nhsrcommunity.com/style-guides.html#referencing-r-packages-and-functions-in-text">NHS-R Style</a> and to ensure running of code in Quarto and to update deprecated functions.</p>


</section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0</a></div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nhsrcommunity\.com\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>2025 NHS-R Community âˆ™ Made with <a href="https://quarto.org/"><img src="https://quarto.org/quarto.png" class="img-fluid" alt="Quarto logo blue round circle with a cross within the circumference" width="65"></a></p>
</div>   
    <div class="nav-footer-center">
<p><a href="https://fosstodon.org/@NHSrCommunity" aria-label="Go to NHSR's Fosstodon page" title="mastodon" target="_blank" rel="noopener"> <i class="link-dark me-1" aria-hidden="true"></i> <i class="fa-brands fa-mastodon" aria-label="mastodon"></i></a> <a href="https://bsky.app/profile/nhsrcommunity.bsky.social" aria-label="Go to NHSR's Bluesky page" title="bluesky" target="_blank" rel="noopener"> <i class="link-dark me-1" aria-hidden="true"></i> <iconify-icon role="img" inline="" icon="fa6-brands:bluesky" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Icon bluesky from fa6-brands Iconify.design set."></iconify-icon></a> <a href="https://github.com/nhs-r-community" aria-label="Go to NHSR's GitHub" title="github" target="_blank" rel="noopener"> <i class="link-dark me-1" aria-hidden="true"></i> <i class="fa-brands fa-github" aria-label="github"></i></a> <a href="https://soundcloud.com/nhs-r-community" aria-label="Go to NHSR's SoundCloud" title="soundcloud" target="_blank" rel="noopener"> <i class="link-dark me-1" aria-hidden="true"></i> <i class="fa-brands fa-soundcloud" aria-label="soundcloud"></i></a> <a href="https://www.linkedin.com/in/nhs-r-community-2555a6282/" aria-label="Go to NHSR's LinkedIn" title="LinkedIn" target="_blank" rel="noopener"> <i class="link-dark me-1" aria-hidden="true"></i> <i class="fa-brands fa-linkedin" aria-label="linkedin"></i></a></p>
<div class="toc-actions"><ul><li><a href="https://github.com/nhs-r-community/nhs-r-community/edit/main/blog/using-r-to-track-nhs-winter-pressures.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nhs-r-community/nhs-r-community/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
    <a class="nav-link" href="../accessibility.html">
<p>Accessibility</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../ts-and-cs.html">
<p>Terms and Conditions</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../contact.html">
<p>Contact</p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../licence.html">
<p>Licence</p>
</a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../blog/index.xml">
      <i class="bi bi-rss" role="img" aria-label="RSS blog feed">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>