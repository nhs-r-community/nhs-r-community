{
  "hash": "064d1f30d9f6fca85e9ec9b11100a85a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Annotating SPC plots using annotate with ggplot\"\ndate: \"13 August 2020\"\ndate-modified: \"12 July 2024\"\ncategories:\n  - SPC charts\n  - Statistics\nauthor: Christopher Reading-Skilton\nsubtitle: >\n---\n\nStatistical Process Control (SPC) charts are widely used in healthcare analytics to examine how the metric varies over time and whether this variation is abnormal. Christopher Reading has already published a [blog](https://nhsrcommunity.com/blog/spc-charting-in-r/) on SPC Charts.\n\nHere is a simple example of annotating points and text on SPC plots using {ggplot2} package. We won't explain all the parameters in the annotate function. Instead we see this as a short show and tell piece with signposts at end of the blog.\n\nSo let's get started and generate some dummy data from a normal distribution with a mean of 0 and and a standard deviation of 1.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nset.seed(2020) # set the random number seed to ensure you can replicate this example\ny <- rnorm(30, 0, 1) # generate 30 random numbers for the y-axis\ny <- c(y, rep(NA, 10)) # add 10 NAs to extend the plot (see later)\nx <- 1:length(y) # generate the x-axis\ndf <- tibble(x = x, y = y) # store as a tibble data frame for convenience\n```\n:::\n\n\nNow we can plot the data using {ggplot} function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig1 <- ggplot(df, aes(x, y)) +\n  geom_point(size = 2) +\n  geom_line() +\n  ylim(-4, 4) # increase the y-axis range to aid visualisation\n\nfig1 # plot the data\n```\n\n::: {.cell-output-display}\n![](annotating-spc-plots-using-annotate-with-ggplot_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nOne of the main features of SPC charts are upper and lower control limits. We can now plot this as an SPC chart with lower and upper control limits set at 3 standard deviations from the mean. Although in practice the calculation of control limits differs from this demo, for simplicity we imply control limits and a mean as set numbers. Alternatively, you could use {qicharts2} package to do SPC calculations and then use the generated {ggplot2} object and keep following our steps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig1 <- fig1 +\n  geom_hline(yintercept = c(3, 0, -3), linetype = \"dashed\") + # adds the upper, mean and lower lines\n  annotate(\"label\",\n    x = c(35, 35, 35),\n    y = c(3, 0, -3),\n    color = \"darkgrey\",\n    label = c(\"Upper control limit\", \"Average line\", \"Lower control limit\"),\n    size = 3\n  ) # adds the annotations\n\nfig1 # plot the SPC\n```\n\n::: {.cell-output-display}\n![](annotating-spc-plots-using-annotate-with-ggplot_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nRemarkably we see a point below the lower control limit even though the data are purely pseudo-random. A nice reminder that control limits are guidelines not hard and fast tests of non-randomness. We can now highlight this remarkable special cause data point which is clearly a false signal also known as special cause variation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig1 <- fig1 +\n  annotate(\"point\", x = 18, y = df$y[18], color = \"orange\", size = 4) +\n  annotate(\"point\", x = 18, y = df$y[18])\n\nfig1 # plot the SPC with annotations\n```\n\n::: {.cell-output-display}\n![](annotating-spc-plots-using-annotate-with-ggplot_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nWe can now add a label for the special cause data point. You can play around with the `vjust` value (for example try -1, 0, 1) to get a feel for what it is doing to the vertical position of the label. There is also a `hjust` which operates on the horizontal plane.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig1 <- fig1 +\n  annotate(\"label\", x = 18, y = df$y[18], vjust = 1.5, label = \"Special cause variation\", size = 3)\n\nfig1 # plot the SPC with more annotations\n```\n\n::: {.cell-output-display}\n![](annotating-spc-plots-using-annotate-with-ggplot_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nTo learn more about the annotate function see \n<https://ggplot2.tidyverse.org/reference/annotate.html>\n\nThis blog has been formatted to remove [Latin Abbreviations](https://nhsrway.nhsrcommunity.com/style-guides.html#avoid-latin-abbreviation) and edited for [NHS-R Style](https://nhsrway.nhsrcommunity.com/style-guides.html#referencing-r-packages-and-functions-in-text)\n",
    "supporting": [
      "annotating-spc-plots-using-annotate-with-ggplot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}